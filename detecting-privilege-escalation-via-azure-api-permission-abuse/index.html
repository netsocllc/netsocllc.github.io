<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Detecting Privilege Escalation via Azure API Permission Abuse - NETSOC Cybersecurity</title><meta name=Description content="Premier MDR & Consulting Services"><meta property="og:title" content="Detecting Privilege Escalation via Azure API Permission Abuse"><meta property="og:description" content="Introduction Effective audit trails surrounding sensitive groups is essential when it comes to maintaining secure active directory networks and in some cases required by regulatory compliance frameworks. For cloud and hybrid-AD joined networks there is twice as much work to be done. Leveraging automation to have detections and reporting in place for security professionals is considered best practice and is critical in terms of detecting privilege escalation attacks both on premise and in the cloud."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.netsoc.us/detecting-privilege-escalation-via-azure-api-permission-abuse/"><meta property="og:image" content="https://blog.netsoc.us/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-16T05:15:03+00:00"><meta property="article:modified_time" content="2022-10-16T11:31:14-04:00"><meta property="og:site_name" content="Premier MDR & Consulting Services"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.netsoc.us/logo.png"><meta name=twitter:title content="Detecting Privilege Escalation via Azure API Permission Abuse"><meta name=twitter:description content="Introduction Effective audit trails surrounding sensitive groups is essential when it comes to maintaining secure active directory networks and in some cases required by regulatory compliance frameworks. For cloud and hybrid-AD joined networks there is twice as much work to be done. Leveraging automation to have detections and reporting in place for security professionals is considered best practice and is critical in terms of detecting privilege escalation attacks both on premise and in the cloud."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-Lock-02.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.netsoc.us/detecting-privilege-escalation-via-azure-api-permission-abuse/><link rel=prev href=https://blog.netsoc.us/detecting-azure-lighthouse-attacks/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Detecting Privilege Escalation via Azure API Permission Abuse","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.netsoc.us\/detecting-privilege-escalation-via-azure-api-permission-abuse\/"},"genre":"posts","wordcount":341,"url":"https:\/\/blog.netsoc.us\/detecting-privilege-escalation-via-azure-api-permission-abuse\/","datePublished":"2022-10-16T05:15:03+00:00","dateModified":"2022-10-16T11:31:14-04:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"NETSOC Cybersecurity"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="NETSOC Cybersecurity"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png data-srcset="https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png, https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png 1.5x, https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png 2x" data-sizes=auto alt=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png title=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=https://netsoc.us rel="noopener noreffer" target=_blank>Return Home </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="NETSOC Cybersecurity"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png data-srcset="https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png, https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png 1.5x, https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png 2x" data-sizes=auto alt=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png title=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=https://netsoc.us title rel="noopener noreffer" target=_blank>Return Home</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Detecting Privilege Escalation via Azure API Permission Abuse</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://netsoc.us title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>NETSOC Cybersecurity</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-10-16>2022-10-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;341 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;2 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#detecting-azure-api-permission-abuse>Detecting Azure API Permission Abuse</a><ul><li><a href=#roles>Roles</a></li><li><a href=#kql>KQL</a></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=introduction>Introduction</h1><p>Effective audit trails surrounding sensitive groups is essential when it comes to maintaining secure active directory networks and in some cases required by regulatory compliance frameworks. For cloud and hybrid-AD joined networks there is twice as much work to be done. Leveraging automation to have detections and reporting in place for security professionals is considered best practice and is critical in terms of detecting privilege escalation attacks both on premise and in the cloud. Unfortunately the monitoring of user privileges is no longer enough as more on premise networks connect to the cloud, thus adding more complexity and increasing the threat landscape.</p><h2 id=detecting-azure-api-permission-abuse>Detecting Azure API Permission Abuse</h2><p>Ensuring we grant the right permissions to enterprise applications and application registrations is equally important as doing the same with our users. In some cases, fundamental application management can mitigate more risk than we would expect considering powerful roles and attack paths surrounding APIs. Depending on the initial access of a threat actor, one could create a back door by creating a custom app registration and assigning one of many highly privileged roles available. This back door can go unnoticed without the proper detections in place.</p><h3 id=roles>Roles</h3><p>Thankfully there is a built-in alert with Microsoft Cloud App Security &ldquo;Unusual addition of credentials to an OAuth app that can be used as an indicator of malicious activity. Use the below query to detect these dangerous permissions being added to an application:</p><p><em>Application.ReadWrite.All</em></p><p><em>AppRoleAssignment.ReadWrite.All</em></p><p><em>RoleManagement.ReadWrite.Directory</em></p><p>Information on what permissions are granted through these roles can be found here: <a href=https://learn.microsoft.com/en-us/graph/permissions-reference target=_blank rel="noopener noreffer">https://learn.microsoft.com/en-us/graph/permissions-reference</a></p><h3 id=kql>KQL</h3><p><code>let DangerousPermissions = dynamic(["AppRoleAssignment.ReadWrite.All","Application.ReadWrite.All","RoleManagement.ReadWrite.Directory"]);</code>
<code>AuditLogs</code>
<code>| where OperationName == "Add app role assignment to service principal"</code>
<code>| where Result =~ "success"</code>
<code>| mv-expand TargetResources</code>
<code>| mv-expand TargetResources.modifiedProperties</code>
<code>| where TargetResources_modifiedProperties.displayName == "AppRole.Value"</code>
<code>| extend InitiatingUserOrApp = tostring(InitiatedBy.user.userPrincipalName)</code>
<code>| extend InitiatingIpAddress = tostring(InitiatedBy.user.ipAddress)</code>
<code>| extend UserAgent = iff(AdditionalDetails[0].key == "User-Agent",tostring(AdditionalDetails[0].value),"")</code>
<code>| extend AddedPermission = replace_string(tostring(TargetResources_modifiedProperties.newValue),'"','')</code>
<code>| where AddedPermission in~ ( DangerousPermissions )</code>
<code>| mv-expand TargetResources.modifiedProperties</code>
<code>| where TargetResources_modifiedProperties.displayName == "ServicePrincipal.ObjectID"</code>
<code>| extend ServicePrincipalObjectID = replace_string(tostring(TargetResources_modifiedProperties.newValue),'"','')</code>
<code>| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingUserOrApp, IPCustomEntity = InitiatingIpAddress</code></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-10-16</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.netsoc.us/detecting-privilege-escalation-via-azure-api-permission-abuse/ data-title="Detecting Privilege Escalation via Azure API Permission Abuse" data-via=https://netsoc.us><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.netsoc.us/detecting-privilege-escalation-via-azure-api-permission-abuse/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.netsoc.us/detecting-privilege-escalation-via-azure-api-permission-abuse/ data-title="Detecting Privilege Escalation via Azure API Permission Abuse"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://blog.netsoc.us/detecting-privilege-escalation-via-azure-api-permission-abuse/ data-title="Detecting Privilege Escalation via Azure API Permission Abuse"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://blog.netsoc.us/detecting-privilege-escalation-via-azure-api-permission-abuse/ data-title="Detecting Privilege Escalation via Azure API Permission Abuse"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/detecting-azure-lighthouse-attacks/ class=prev rel=prev title="Detecting Azure Lighthouse Privilege Escalation Attacks"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Detecting Azure Lighthouse Privilege Escalation Attacks</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2020 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://netsoc.us target=_blank>NETSOC Cybersecurity</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},cookieconsent:{content:{dismiss:"Got it!",link:"Learn more",message:"This website uses Cookies to improve your experience."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>