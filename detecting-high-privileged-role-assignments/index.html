<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Detecting Privilege Escalation via High Privileged Role Assignments - NETSOC Cybersecurity</title><meta name=Description content="Premier MDR & Consulting Services"><meta property="og:title" content="Detecting Privilege Escalation via High Privileged Role Assignments"><meta property="og:description" content="Introduction It&rsquo;s no secret that information security teams should have detections in place to detect unusual changes in high privilege roles. Accidentally assigning the wrong Azure AD role can be catastrophic if a high privileged user or managed identity is to unknowingly fall victim to compromise. There are a number of roles which should be considered sensitive, these should be heavily monitored and periodically audited.
Some examples of these roles include but are not limited to the following:"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.netsoc.us/detecting-high-privileged-role-assignments/"><meta property="og:image" content="https://blog.netsoc.us/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-16T06:15:03+00:00"><meta property="article:modified_time" content="2022-10-16T18:40:45-04:00"><meta property="og:site_name" content="Premier MDR & Consulting Services"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.netsoc.us/logo.png"><meta name=twitter:title content="Detecting Privilege Escalation via High Privileged Role Assignments"><meta name=twitter:description content="Introduction It&rsquo;s no secret that information security teams should have detections in place to detect unusual changes in high privilege roles. Accidentally assigning the wrong Azure AD role can be catastrophic if a high privileged user or managed identity is to unknowingly fall victim to compromise. There are a number of roles which should be considered sensitive, these should be heavily monitored and periodically audited.
Some examples of these roles include but are not limited to the following:"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-Lock-02.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.netsoc.us/detecting-high-privileged-role-assignments/><link rel=prev href=https://blog.netsoc.us/detecting-privilege-escalation-via-azure-api-permission-abuse/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Detecting Privilege Escalation via High Privileged Role Assignments","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.netsoc.us\/detecting-high-privileged-role-assignments\/"},"genre":"posts","wordcount":387,"url":"https:\/\/blog.netsoc.us\/detecting-high-privileged-role-assignments\/","datePublished":"2022-10-16T06:15:03+00:00","dateModified":"2022-10-16T18:40:45-04:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"NETSOC Cybersecurity"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="NETSOC Cybersecurity"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png data-srcset="https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png, https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png 1.5x, https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png 2x" data-sizes=auto alt=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png title=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=https://netsoc.us rel="noopener noreffer" target=_blank>Return Home </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="NETSOC Cybersecurity"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png data-srcset="https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png, https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png 1.5x, https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png 2x" data-sizes=auto alt=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png title=https://netsoc.us/wp-content/uploads/2022/09/NETSOC-logo.png></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=https://netsoc.us title rel="noopener noreffer" target=_blank>Return Home</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Detecting Privilege Escalation via High Privileged Role Assignments</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://netsoc.us title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>NETSOC Cybersecurity</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-10-16>2022-10-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;387 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;2 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#requirements>Requirements</a></li><li><a href=#kql>KQL</a></li></ul></nav></div></div><div class=content id=content><h1 id=introduction>Introduction</h1><p>It&rsquo;s no secret that information security teams should have detections in place to detect unusual changes in high privilege roles. Accidentally assigning the wrong Azure AD role can be catastrophic if a high privileged user or managed identity is to unknowingly fall victim to compromise. There are a number of roles which should be considered sensitive, these should be heavily monitored and periodically audited.</p><p>Some examples of these roles include but are not limited to the following:</p><p><em>Global Administrator</em></p><p><em>Company Administrator</em></p><p><em>Privileged Authentication Administrator</em></p><p><em>Privileged Role Administrator</em></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/Detecting-High-Privileged-Role-Assignments.assets/image-20221016183058877.png data-srcset="/posts/Detecting-High-Privileged-Role-Assignments.assets/image-20221016183058877.png, /posts/Detecting-High-Privileged-Role-Assignments.assets/image-20221016183058877.png 1.5x, /posts/Detecting-High-Privileged-Role-Assignments.assets/image-20221016183058877.png 2x" data-sizes=auto alt=/posts/Detecting-High-Privileged-Role-Assignments.assets/image-20221016183058877.png title=image-20221016183058877></p><p>Note: As if having to monitor and detect changes in permissions with our users wasn&rsquo;t a complex task, organizations should equally monitor the permissions and roles across APIs more on this here: <a href=https://blog.netsoc.us/detecting-privilege-escalation-via-azure-api-permission-abuse/ target=_blank rel="noopener noreffer">https://blog.netsoc.us/detecting-privilege-escalation-via-azure-api-permission-abuse/</a></p><h2 id=requirements>Requirements</h2><p>In order to detect changes to high privileged roles in Azure AD, it&rsquo;s required the data connector &ldquo;Azure Active Directory&rdquo; be connected and Audit Logs be ingested into Azure Sentinel. Global Administrator or Security Administrator is required in order to make this connection, along with the proper permissions at the Workspace or Resource group level to make changes to the workspace. Additionally, read and write permissions to AAD diagnostic settings must be available.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/posts/Detecting-High-Privileged-Role-Assignments.assets/image-20221016183203663.png data-srcset="/posts/Detecting-High-Privileged-Role-Assignments.assets/image-20221016183203663.png, /posts/Detecting-High-Privileged-Role-Assignments.assets/image-20221016183203663.png 1.5x, /posts/Detecting-High-Privileged-Role-Assignments.assets/image-20221016183203663.png 2x" data-sizes=auto alt=/posts/Detecting-High-Privileged-Role-Assignments.assets/image-20221016183203663.png title=image-20221016183203663></p><h2 id=kql>KQL</h2><p>Query to detect changes across the aforementioned roles, feel free to add additional high privileged roles like Security Administrator, Exchange Administrator, or Application Administrator.</p><p><code>let HighPrivRoles = dynamic(["Global Administrator","Company Administrator","Privileged Authentication Administrator","Privileged Role Administrator"]);</code>
<code>AuditLogs</code>
<code>| where OperationName == "Add member to role"</code>
<code>| mv-expand TargetResources</code>
<code>| mv-expand TargetResources.modifiedProperties</code>
<code>| where TargetResources_modifiedProperties.displayName == "Role.DisplayName"</code>
<code>| extend AddedToRole = replace_string(tostring(TargetResources_modifiedProperties.newValue),'"','')</code>
<code>| where AddedToRole in~ (HighPrivRoles)</code>
<code>| extend Actor = iff(isnotempty(InitiatedBy.user.userPrincipalName),InitiatedBy.user.userPrincipalName,InitiatedBy.app.servicePrincipalId)</code>
<code>| extend TargetUsername = TargetResources.userPrincipalName</code></p><p>Depending on your environment, it may be beneficial to monitor specific changes like password changes across these high privileged roles. Again, feel free to add additional roles or activity as necessary.</p><p><code>let HighPrivRoles = dynamic(["Global Administrator", "Company Administrator", "Privileged Authentication Administrator", "Privileged Role Administrator"]);</code>
<code>AuditLogs</code>
<code>| where OperationName == "Reset user password"</code>
<code>| mv-expand TargetResources</code>
<code>| extend TargetUsername = tostring(TargetResources.userPrincipalName)</code>
<code>| join kind=innerunique (</code>
<code>IdentityInfo</code>
<code>| where TimeGenerated > ago(14d)</code>
<code>)</code>
<code>on $left.TargetUsername == $right.AccountUPN</code>
<code>| mv-expand AssignedRoles</code>
<code>| extend AssignedRoles = tostring(AssignedRoles)</code>
<code>| where AssignedRoles in (HighPrivRoles)</code>
<code>| summarize by TimeGenerated, TargetUsername, AssignedRoles, OperationName, AADUserId=AccountObjectId</code></p><p>Pro tip: It may be a good idea to generate a weekly or bi-weekly report to audit and review these changes.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-10-16</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.netsoc.us/detecting-high-privileged-role-assignments/ data-title="Detecting Privilege Escalation via High Privileged Role Assignments" data-via=https://netsoc.us><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.netsoc.us/detecting-high-privileged-role-assignments/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.netsoc.us/detecting-high-privileged-role-assignments/ data-title="Detecting Privilege Escalation via High Privileged Role Assignments"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://blog.netsoc.us/detecting-high-privileged-role-assignments/ data-title="Detecting Privilege Escalation via High Privileged Role Assignments"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://blog.netsoc.us/detecting-high-privileged-role-assignments/ data-title="Detecting Privilege Escalation via High Privileged Role Assignments"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/detecting-privilege-escalation-via-azure-api-permission-abuse/ class=prev rel=prev title="Detecting Privilege Escalation via Azure API Permission Abuse"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Detecting Privilege Escalation via Azure API Permission Abuse</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2020 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://netsoc.us target=_blank>NETSOC Cybersecurity</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},cookieconsent:{content:{dismiss:"Got it!",link:"Learn more",message:"This website uses Cookies to improve your experience."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>